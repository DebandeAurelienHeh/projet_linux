#!/bin/bash
                                                                                                                                                                                                                 # === CONFIGURATION ===                                                                                                                                                                                          LOCAL_DIR="/srv"                                                                                                                                                                                                 REMOTE_USER="ec2-user"
REMOTE_HOST="10.42.0.49"                                                                                                                                                                                        REMOTE_DIR="/backup/app"
PEM_KEY_PATH="/key/labsuserAurelien.pem"                                                                                                                                                                                                                                                                                                                                                                                  DATE=$(date +"%Y-%m-%d_%H-%M-%S")
DAY_OF_WEEK=$(date +%u)                                                                                                                                                                                          ARCHIVE_NAME="backup_${DATE}.tar.gz"                                                                                                                                                                             TEMP_ARCHIVE="/tmp/$ARCHIVE_NAME"
SNAPSHOT_FILE="/tmp/rsync-backup.snar"                                                                                                                                                                                                                                                                                                                                                                                            # === TYPE DE SAUVEGARDE ===                                                                                                                                                                                     if [ "$DAY_OF_WEEK" -eq 7 ]; then
    BACKUP_TYPE="différentielle"                                                                                                                                                                                     rm -f "$SNAPSHOT_FILE"
else                                                                                                                                                                                                                 BACKUP_TYPE="incrémentielle"                                                                                                                                                                                 fi                                                                                                                                                                                                                                                                                                                                                                                                                                echo "[*] Démarrage d'une sauvegarde $BACKUP_TYPE"
echo "[*] Compression de $LOCAL_DIR..."
tar --listed-incremental="$SNAPSHOT_FILE" -czf "$TEMP_ARCHIVE" -C "$LOCAL_DIR" .                                                                                                                                                                                                                                                                                                                                                  # === TRANSFERT VERS /tmp ===
echo "[*] Transfert vers $REMOTE_HOST:/tmp/$ARCHIVE_NAME"
scp -i "$PEM_KEY_PATH" "$TEMP_ARCHIVE" "$REMOTE_USER@$REMOTE_HOST:/tmp/$ARCHIVE_NAME"                                                                                                                                                                                                                                                                                                                                             # === DEPLACEMENT AVEC SUDO SUR LE SERVEUR DISTANT ===
echo "[*] Déplacement vers $REMOTE_DIR avec sudo..."
ssh -i "$PEM_KEY_PATH" "$REMOTE_USER@$REMOTE_HOST" "sudo mv /tmp/$ARCHIVE_NAME $REMOTE_DIR/"                                                                                                                                                                                                                                                                                                                                      # === NETTOYAGE LOCAL ===
echo "[*] Suppression locale de l'archive temporaire..."                                                                                                                                                         rm -f "$TEMP_ARCHIVE"                                                                                                                                                                                                                                                                                                                                                                                                             echo "[✓] Sauvegarde $BACKUP_TYPE terminée : $ARCHIVE_NAME" 